#!/usr/bin/env bash

set -e

usage() {
    echo "Usage: $0 [<branch-to-rebase-on>]   (default branch=master)"
    exit
}

if [ "$#" -eq 1 ]; then
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
  else
    target="$1"
  fi
elif [ "$#" -eq 0 ]; then
  target=master
else
  usage
fi
old_branch=$(git rev-parse --abbrev-ref HEAD)
git fetch
if ! git diff --quiet ${target}..origin/${target}; then
  if ! git diff --quiet; then
    stashed=1
    git stash
  fi
  git checkout ${target}
  git merge --ff-only origin/${target}
  git checkout $old_branch
  git rebase ${target}
  if [ -n "$stashed" ]; then
    git stash pop
  fi
fi
git-purge-merged-branches || echo "Failed to delete some merged branches, continuing."
