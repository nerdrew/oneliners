#!/usr/bin/env bash

set -e

# This has to be run from master
old_branch=$(git rev-parse --abbrev-ref HEAD)
git fetch
if ! git diff --quiet master..origin/master; then
  if ! git diff --quiet; then
    stashed=1
    git stash
  fi
  git checkout master
  git merge --ff-only origin/master
  git checkout $old_branch
  git rebase master
  if [ -n "$stashed" ]; then
    git stash pop
  fi
fi
git-purge-merged-branches || echo "Failed to delete some merged branches, continuing."
