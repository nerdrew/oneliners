#!/bin/bash

set -e

usage() {
    echo "Usage: $0 [<branch-to-rebase-on>]   (default branch=origin/master)"
    exit
}

if [ "$#" -eq 1 ]; then
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
  else
    target="$1"
  fi
elif [ "$#" -eq 0 ]; then
  target=origin/master
else
  usage
fi
git fetch --prune
if ! git diff --quiet $(git merge-base HEAD ${target})..${target}; then
  if ! git diff --quiet; then
    stashed=1
    git stash
  fi
  git rebase ${target}
  if [ -n "$stashed" ]; then
    git stash pop
  fi
fi
git-purge-merged-branches || echo "Failed to delete some merged branches, continuing."
