#!/bin/bash

set -e

usage() {
    echo "Usage: $0 [--remote]"
    exit
}

keep_branches="$GIT_PURGE_KEEP_BRANCHES master$"

# Remove local fully merged branches
merged_local=$(git branch --merged origin/master | grep -v '^\*' || true)
for branch in $(echo "$keep_branches"); do
  merged_local=$(echo "$merged_local" | egrep -v "$branch" || true)
done

if [ -n "$merged_local" ]; then
  echo "The following local branches are fully merged and will be removed:"
  echo "$merged_local"
  git branch -d $merged_local
fi

while (( "$#" )); do
  if [ "$1" == "--remote" ]; then
    purge_remote=1
  elif [ "$1" == "--tags" ]; then
    purge_tags=1
  else
    usage
  fi

  shift
done

if [ -n "$purge_remote" ]; then
  # Show remote fully merged branches
  merged_remote=$(git branch -r --merged origin/master | sed 's/ *origin\///')
  for branch in $(echo "$keep_branches"); do
    merged_remote=$(echo "$merged_remote" | egrep -v "$branch" || true)
  done

  if [ -n "$merged_remote" ]; then
    echo "The following remote branches are fully merged and will be removed:"
    echo "$merged_remote"

    read -p "Continue (y/n)? " CLEAN_REMOTE_BRANCHES
    if [ "$CLEAN_REMOTE_BRANCHES" == "y" ]; then
      echo "$merged_remote" | xargs -I% git push origin :%
    fi
  fi
fi

if [ -n "$purge_tags" ]; then
  git fetch --prune origin '+refs/tags/*:refs/tags/*'
fi
