#!/bin/bash

set -eu -o pipefail

usage() {
  echo "Usage: $0 [<branch1>] [<branch2>]   (default branch1=origin/master branch2=HEAD)"
}

if [ $# -eq 0 ]; then
  branch2=$(git rev-parse --abbrev-ref HEAD)
  branch1=origin/$branch2
elif [ $# -eq 1 ]; then
  if [[ $1 == "-h" || $1 == "--help" ]]; then
    usage
    exit
  fi
  branch1=origin/$1
  branch2=$1
elif [ $# -eq 2 ]; then
  branch1=$1
  branch2=$2
else
  usage
  exit 1
fi

mergebase=$(git merge-base "$branch1" "$branch2")
commits1=$(git log --oneline "$mergebase..$branch1" | wc -l)
commits2=$(git log --oneline "$mergebase..$branch2" | wc -l)

commits=$(( commits1 > commits2 ? commits2 : commits1 ))

diff -U0 --label "$branch1" --label "$branch2" \
  <(git log -u -$commits "$mergebase...$branch1" \
    | grep -vE '^(@@ -\d+,\d+ \+\d+,\d+|index \w{7}\.\.\w{7}|commit \w{40})') \
  <(git log -u -$commits "$mergebase...$branch2" \
    | grep -vE '^(@@ -\d+,\d+ \+\d+,\d+|index \w{7}\.\.\w{7}|commit \w{40})') \
