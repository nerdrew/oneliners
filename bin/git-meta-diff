#!/usr/bin/env bash

set -eu -o pipefail

usage() {
  cat <<EOF 
Usage: git meta-diff [git-log-options] [BRANCH1=origin/BRANCH2] [BRANCH2=HEAD] [-- paths...]

Show the diff of the \`git log\` between BRANCH1 and BRANCH2.
EOF

  exit "$1"
}

main() {
  local branch1 branch2 mergebase1
  local -a diffopts paths

  diffopts=()

  while (( $# )); do
    if [[ -z "$1" ]]; then
      break
    elif [[ $1 == "-h" || $1 == "--help" ]]; then
      usage 0
    elif [[ ${1} == "--" ]]; then
      paths=("${@}")
      break
    elif [[ ${1:0:1} == "-" ]]; then
      diffopts+=("$1")
    elif [[ -z "${branch1:-}" ]]; then
      branch1=$1
    elif [[ -z "${branch2:-}" ]]; then
      branch2=$1
    else
      usage 1
    fi

    shift
  done

  branch2=${branch2:-$(git rev-parse --abbrev-ref HEAD)}
  branch1=${branch1:-origin/$branch2}


  mergebase1=$(git merge-base origin/master "$branch1")
  mergebase2=$(git merge-base origin/master "$branch2")

  diff -U0 --label "$branch1" --label "$branch2" \
    <(git diff "${diffopts[@]}" "$mergebase1...$branch1" "${paths[@]:-.}" \
    | grep -vE '^(@@[-0-9,+ ]+@@|index \w{7,}\.\.\w{7,}|commit \w{40})') \
    <(git diff "${diffopts[@]}" "$mergebase2...$branch2" "${paths[@]:-.}" \
    | grep -vE '^(@@[-0-9,+ ]+@@|index \w{7,}\.\.\w{7,}|commit \w{40})')
}

main "$@"
