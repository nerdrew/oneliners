#!/usr/bin/env ruby

require 'shellwords'

usage = "Usage: #{$0} [--sudo USER] <files...> [<user>@]<hostname>[:<path> | ~]"
if ARGV.size < 2
  puts usage
  exit 0
end

host, path = ARGV.pop.split(':')
path = " -C #{path}" if path

if ARGV[0].start_with?("--")
  if ARGV[0] == "--sudo"
    ARGV.shift
    sudo = "sudo -iu #{ARGV.shift} "
  else
    warn "Unknown arg: #{ARGV[0]}"
    puts usage
    exit 1
  end
end

files = Shellwords.join(ARGV)

cmd = "tar -Hzc - #{files} | ssh #{host} #{sudo}tar -zvx#{path}"
puts "Running: `#{cmd}`"
exit 1 unless system(cmd)
