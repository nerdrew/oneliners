#!/bin/bash

set -eu -o pipefail

usage() {
  cat <<EOF
Usage: git ctags [--[no-]ruby] [ctags options]

Build ctags. By default it checks for a Gemfile to determine whether it is a ruby project.
EOF

  exit "$1"
}

main() {
  local -a common_args=("--tag-relative=yes" -f .git/tags) extra_ctags_args=("--languages=-sql" -L .git/tags.files)
  local ruby

  if [[ -f Gemfile ]]; then
    ruby=y
  fi

  while (( $# )); do
    case "$1" in
      -h|--help)
        usage 0
        ;;
      --ruby)
        ruby=y
        ;;
      --no-ruby)
        ruby=""
        ;;
      *)
        extra_ctags_args+=("$1")
        ;;
    esac

    shift
  done


  if [[ "$(command -v ctags)" != "/usr/bin/ctags" ]]; then
    rg --files -g '!*.sql' -g '!*.xml' > .git/tags.files

    if [[ -n "$ruby" ]]; then
      rg --files -g '*.rb' > .git/ruby-tags.files
      ripper-tags "${common_args[@]}" -L .git/ruby-tags.files || (echo "ripper-tags errored, is it installed? gem install ripper-tags" && exit 1)
      ctags "${common_args[@]}" --append --languages=-ruby "${extra_ctags_args[@]}"
    else
      ctags "${common_args[@]}" "${extra_ctags_args[@]}"
    fi
  else
    echo "brew install ctags or brew install --HEAD universal-ctags/universal-ctags/universal-ctags" >&2
    exit 1
  fi
}

main "$@"
